<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">
	<head>
	  <meta charset="UTF-8">
	  <meta name="viewport" content="width=device-width, initial-scale=1.0">
	  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
	  <title>Trabalho Engenharia</title>
	  	<style>
	      body {
	        font-family: Arial, sans-serif;
	        margin: 0;
	        padding: 0;
	        background-color: #f6f8fa;
	      }

	      /* Barra de navega√ß√£o superior */
	      .navbar {
	        background-color: #24292f;
	        color: white;
	        padding: 10px 20px;
	        display: flex;
	        justify-content: space-between;
	        align-items: center;
	        position: relative;
	      }

	      .navbar .logo {
	        font-size: 24px;
	        font-weight: bold;
	      }

	      .navbar .search-bar {
	        display: flex;
	        justify-content: center;
	        align-items: center;
	        flex: 1;
	        margin: 0 20px;
	      }

	      .navbar .search-bar input {
	        padding: 5px 15px;
	        border: 1px solid #ccc;
	        border-radius: 20px;
	        width: 400px;
	      }

	      /* Bot√£o de usu√°rio/login */
	      .navbar .login-btn {
	        background-color: #2c974b;
	        color: white;
	        padding: 8px 16px;
	        border-radius: 20px;
	        text-decoration: none;
	        transition: background-color 0.3s;
	      }

	      .navbar .login-btn:hover {
	        background-color: #238a3b;
	      }

	      /* Sidebar */
	      .sidebar {
	        width: 250px;
	        background-color: #24292f;
	        color: white;
	        height: 100vh;
	        position: fixed;
	        top: 0;
	        left: 0;
	        padding-top: 20px;
	        display: flex;
	        flex-direction: column;
	      }

	      .sidebar a {
	        color: white;
	        text-decoration: none;
	        padding: 12px 20px;
	        border-bottom: 1px solid #444;
	        transition: background-color 0.3s;
	      }

	      .sidebar a:hover {
	        background-color: #444;
	      }

	      /* Conte√∫do principal */
	      .content {
	        margin-left: 270px;
	        padding: 20px;
	      }

	      .content .title {
	        font-size: 28px;
	        margin-bottom: 20px;
	      }

	      /* Tabela de reposit√≥rios */
	      .repo-table {
	        width: 100%;
	        border-collapse: collapse;
	      }

	      .repo-table th, .repo-table td {
	        padding: 12px 15px;
	        border: 1px solid #ddd;
	        text-align: left;
	      }

	      .repo-table th {
	        background-color: #24292f;
	        color: white;
	      }

	      .repo-table tr:nth-child(even) {
	        background-color: #f9f9f9;
	      }

	      .repo-table tr:hover {
	        background-color: #f1f1f1;
	      }

	      /* Bot√£o de a√ß√£o para cada reposit√≥rio */
	      .view-repo-btn {
	        background-color: #2c974b;
	        color: white;
	        padding: 8px 16px;
	        border-radius: 6px;
	        text-decoration: none;
	        transition: background-color 0.3s;
	      }

	      .view-repo-btn:hover {
	        background-color: #238a3b;
	      }

	      /* Estilo para a tela de detalhes do reposit√≥rio */
	      .repo-details {
	        margin-top: 30px;
	      }

	      .repo-details .version-select {
	        margin-bottom: 20px;
	      }

	      .repo-details .file-list {
	        list-style: none;
	        padding-left: 0;
	      }

	      .repo-details .file-list li {
	        padding: 8px;
	        border: 1px solid #ddd;
	        margin-bottom: 10px;
	        background-color: #f9f9f9;
	      }

	      .repo-details .file-list li:hover {
	        background-color: #f1f1f1;
	      }

	      .repo-details .file-list li a {
	        text-decoration: none;
	        color: #24292f;
	      }

	      /* Estilos para mensagens de estado */
	      .loading-message, .no-files-message {
	        text-align: center;
	        padding: 20px;
	        color: #666;
	        font-style: italic;
	      }

	      .loading-message {
	        background-color: #f8f9fa;
	        border: 1px solid #e9ecef;
	        border-radius: 6px;
	      }

	      .no-files-message {
	        background-color: #fff3cd;
	        border: 1px solid #ffeaa7;
	        border-radius: 6px;
	        color: #856404;
	      }

		  .btn-download {
			margin-top: 20px;
			padding: 15px;
			background-color: #f8f9fa;
			border: 1px solid #a5a5a5;
			border-radius: 6px;
			color: #868686;
			cursor: pointer;
			margin-right: 10px;
		  }

		  .btn-download:hover {
			background-color: #ebebeb;
			border: 1px solid #a5a5a5;
			color: #868686;
		  }

		  .btn-commit {
			margin-top: 20px;
			padding: 15px;
			background-color: #f8f9fa;
			border: 1px solid #a5a5a5;
			border-radius: 6px;
			color: #868686;
			cursor: pointer;
			margin-right: 10px;
		  }

		  .btn-commit:hover {
			background-color: #ebebeb;
			border: 1px solid #a5a5a5;
			color: #868686;
		  }
		</style>
	</head>
	<body>
	  <!-- Barra de navega√ß√£o -->
	  <div class="navbar">
	    <div class="search-bar">
	      <input type="text" placeholder="Pesquisar reposit√≥rios...">
	    </div>
	    <a href="#" class="login-btn">Login</a>
	  </div>

	  <!-- Sidebar -->
	  <div class="sidebar">
	    <a href="/index">In√≠cio</a>
	    <a th:href="@{/repositorio/colaboradores(rep_id=${repositorio.id})}">Colaboradores</a>
	  </div>

	  <!-- Conte√∫do principal -->
	  <div class="content" id="vue-app">
		<div class="title">
			<span th:if="${repositorio != null}" th:text="${repositorio.nome}">Nome do Reposit√≥rio</span>
			<span th:if="${repositorio == null}">Reposit√≥rio n√£o encontrado</span>
		</div>

	    <!-- Sele√ß√£o de vers√£o do hist√≥rico -->
	    <div th:if="${commits != null}">
		    <div class="repo-details">
		      <div class="version-select" th:if="${commits != null}">
		        <label for="version">Selecionar vers√£o:</label>	       
				<input type="hidden" id="rep_id" name="rep_id" th:value="${repositorio.id}">
				<select id="commit_id" name="commit_id" @change="getCommit">
					<option value="">Selecione uma vers√£o...</option>
					<option th:each="com : ${commits}" th:value="${com.id}" th:text="${com.id}"></option>
				</select>
		      </div>
	      	</div>
		</div>
		
		<!-- Mensagem quando n√£o h√° commits -->
		<div th:if="${commits == null}" style="margin-top: 20px; padding: 15px; background-color: #f8f9fa; border: 1px solid #e9ecef; border-radius: 6px; color: #6c757d;">
			<p><strong>Reposit√≥rio vazio</strong></p>
			<p>Este reposit√≥rio ainda n√£o possui commits. Fa√ßa o primeiro commit para come√ßar a versionar seus arquivos.</p>
		</div>

	      <!-- Bot√µes de a√ß√£o -->
	    <div style="margin-top: 30px;" >
	    	<form method="post" th:action="@{/baixarRepositorio}" th:if="${commit != null}">
				<input type="hidden" id="commit_id" name="commit_id" th:value="${commit.id}">
				<input type="hidden" id="rep_id" name="rep_id" th:value="${repositorio.id}">
		        <button class="btn-download">üì• Baixar reposit√≥rio</button>
	        </form>
	    	
			<button th:onclick="'window.location.href = \'/upload?rep_id=' + ${repositorio.id} + '\''" class="btn-commit">	
				‚úÖ Fazer novo commit
			</button>				
	    </div>	  
			<div id="file-list-container">
				<div class="file-list" v-if="arquivos.length > 0">
					<div v-if="commitInfo">
						<h3>Informa√ß√µes do Commit:</h3>
						<p>ID: {{ commitInfo.id }}</p>
						<p>Mensagem: {{ commitInfo.msg }}</p>
						</div>						
		        	<h3>Arquivos do Reposit√≥rio:</h3>
			          <table>
			          	<tr>
			          		<th>Nome</th>
			          	</tr>
			          	<tr v-for="arquivo in arquivos" :key="arquivo.id">
			          		<td>{{ arquivo.nome }}</td>
			          	</tr>
			          </table>
		    	</div>
		    	<div v-else-if="loading" class="loading-message">
		    		<p>Carregando arquivos...</p>
		    	</div>
			</div>
		</div>
	  </div>

	  <script th:inline="javascript">
		// Dados vindos do servidor via Thymeleaf
		const serverArquivos = /*[[${arquivos}]]*/ [];
		const serverCommit = /*[[${commit}]]*/ {};
	  </script>
	  
	  <script>
	    const { createApp, ref, onMounted } = Vue;
		createApp({
			setup() {
				// Dados reativos
				const arquivos = ref((serverArquivos || []).map(arquivo => ({
					id: arquivo.id,
					nome: arquivo.nome
				})));
				const commitInfo = ref(serverCommit || {});
				const loading = ref(false);
				
				// Requisi√ß√£o para buscar os arquivos do commit selecionado
				const getCommit = async (event) => {
					// Pega o id do commit selecionado
					const commitId = event.target.value;
					// Pega o id do reposit√≥rio
					const repId = document.getElementById('rep_id').value;
					// Se n√£o for passado um commitId
					if (!commitId) {
						arquivos.value = []; // Limpar lista
						return;
					}
					
					loading.value = true;
					
					try {
						// Requisi√ß√£o para buscar os arquivos do commit selecionado
						const response = await fetch(`/api/get_commit?rep_id=${repId}&commit_id=${commitId}`);
						// Se a requisi√ß√£o for ok
						if (response.ok) {
							// Pega os dados do commit
							const arquivosData = await response.json();
							console.log('Arquivos do commit:', arquivosData);
							
							// Atualizar a lista reativa de arquivos com os dados do commit
							arquivos.value = arquivosData;
						// Se a requisi√ß√£o for n√£o ok
						} else {
							console.error('Erro HTTP:', response.status);
							alert('Erro ao carregar arquivos do commit');
							// Limpar lista
							arquivos.value = [];
						}
					} catch (error) {
						// Se houver um erro
						console.error('Erro ao buscar commit:', error);
						alert('Erro de conex√£o ao buscar commit');
						arquivos.value = [];
					} finally {
						getCommitInfo(commitId);
						loading.value = false;
					}
				};
				// Requisi√ß√£o para buscar as informa√ß√µes do commit selecionado
				const getCommitInfo = async (commitId) => {
					// Se n√£o for passado um commitId
					if (!commitId) {
						// Limpar as informa√ß√µes do commit
						commitInfo.value = {};
						return;
					}
					try {
						// Requisi√ß√£o para buscar as informa√ß√µes do commit selecionado
						const response = await fetch(`/api/get_commit_info?commit_id=${commitId}`);
						const commitData = await response.json();
						// Atualizar a vari√°vel reativa do commit com os dados do commit
						commitInfo.value = commitData;
					} catch (error) {
						// Se houver um erro
						alert('Erro de conex√£o ao buscar informa√ß√µes do commit');
						commitInfo.value = {};
					}
				};
				
				// Retornar tudo que ser√° usado no template Vue.js
				return {
					arquivos,
					commitInfo,
					loading,
					getCommit,
					getCommitInfo
				};
			}
		}).mount('#vue-app');
	  </script>
	</body>
	</html>
